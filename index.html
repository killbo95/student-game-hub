<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GameHub — Upload & Play (Starter)</title>
  <style>
    /* (styles unchanged for brevity) */
  </style>
</head>
<body>
  <!-- (HTML structure unchanged) -->
  <script>
    // Simple client-side library stored in localStorage
    const typeEl = document.getElementById('type');
    const htmlUpload = document.getElementById('html-upload');
    const scratchUpload = document.getElementById('scratch-upload');
    const pythonUpload = document.getElementById('python-upload');
    const addBtn = document.getElementById('addBtn');
    const gallery = document.getElementById('gallery');
    const player = document.getElementById('player');
    const clearBtn = document.getElementById('clearBtn');
    const refreshBtn = document.getElementById('refreshBtn');

    function showSections(){
      const t = typeEl.value;
      htmlUpload.style.display = t==='html'? 'block':'none';
      scratchUpload.style.display = t==='scratch'? 'block':'none';
      pythonUpload.style.display = t==='python'? 'block':'none';
    }
    typeEl.addEventListener('change', showSections);

    function loadLibrary(){
      const raw = localStorage.getItem('gamehub_lib');
      return raw? JSON.parse(raw) : [];
    }
    function saveLibrary(list){ localStorage.setItem('gamehub_lib', JSON.stringify(list)); }

    function renderGallery(){
      const list = loadLibrary();
      gallery.innerHTML='';
      if(!list.length){ gallery.innerHTML='<div class="muted">No games yet — add one from the left panel.</div>'; return }
      list.forEach((g, idx)=>{
        const el = document.createElement('div'); el.className='game-card';
        const thumb = document.createElement('div'); thumb.className='thumb';
        if(g.thumb){ const img = document.createElement('img'); img.src = g.thumb; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; thumb.innerHTML=''; thumb.appendChild(img);} else { thumb.textContent=g.type.toUpperCase() }
        const meta = document.createElement('div'); meta.className='meta';
        const title = document.createElement('h3'); title.textContent = g.name || 'Untitled';
        const small = document.createElement('small'); small.textContent = g.type + ' • ' + (new Date(g.added).toLocaleString());
        meta.appendChild(title); meta.appendChild(small);
        const desc = document.createElement('div'); desc.className='muted'; desc.textContent = g.desc || '';
        const playBtn = document.createElement('button'); playBtn.className='btn'; playBtn.style.fontSize='13px'; playBtn.textContent='Play';
        playBtn.addEventListener('click', ()=> loadToPlayer(g));
        const del = document.createElement('button'); del.textContent='Delete'; del.style.marginLeft='8px'; del.addEventListener('click', ()=>{ if(confirm('Delete "'+g.name+'"?')){ const arr=loadLibrary(); arr.splice(idx,1); saveLibrary(arr); renderGallery(); }});
        const actions = document.createElement('div'); actions.style.marginTop='6px'; actions.appendChild(playBtn); actions.appendChild(del);

        el.appendChild(thumb); el.appendChild(meta); el.appendChild(desc); el.appendChild(actions);
        gallery.appendChild(el);
      })
    }

    async function fileToDataURL(file){ return new Promise((res,rej)=>{ const r = new FileReader(); r.onload = e=>res(e.target.result); r.onerror=rej; r.readAsDataURL(file); }) }

    addBtn.addEventListener('click', async ()=>{
      const t = typeEl.value; const name = document.getElementById('name').value.trim(); const desc = document.getElementById('desc').value.trim();
      const thumbFile = document.getElementById('thumb').files[0];
      let thumb = null; if(thumbFile) thumb = await fileToDataURL(thumbFile);

      const lib = loadLibrary();
      const item = { type:t, name: name||('Untitled-'+Date.now()), desc, thumb, added: new Date().toISOString() };

      if(t==='html'){
        const file = document.getElementById('htmlfile').files[0];
        const url = document.getElementById('htmlurl').value.trim();
        if(file){
          const txt = await fileToDataURL(file);
          item.payload = { kind:'inline', data: txt };
        } else if(url){
          item.payload = { kind:'url', data: url };
        } else { alert('Provide an index.html file or an URL'); return }
      }

      if(t==='scratch'){
        const val = document.getElementById('scratchid').value.trim();
        if(!val){ alert('Enter Scratch project id or URL'); return }
        let pid = val;
        const m = val.match(/projects\/(\d+)/);
        if(m) pid = m[1];
        item.payload = { kind:'turbowarp', data: pid };
      }

      if(t==='python'){
        const file = document.getElementById('pyfile').files[0];
        const code = document.getElementById('pycode').value.trim();
        if(file){ item.payload = { kind:'inline', data: await fileToDataURL(file) } }
        else if(code){ item.payload = { kind:'code', data: code } }
        else { alert('Provide a .py file or paste code'); return }
      }

      lib.unshift(item); saveLibrary(lib); renderGallery();
      document.getElementById('name').value=''; document.getElementById('desc').value=''; document.getElementById('htmlfile').value=''; document.getElementById('htmlurl').value=''; document.getElementById('scratchid').value=''; document.getElementById('pyfile').value=''; document.getElementById('pycode').value=''; document.getElementById('thumb').value='';
    });

    function loadToPlayer(g){
      player.innerHTML='';
      if(g.type==='html'){
        if(g.payload.kind==='url'){
          const ifr = document.createElement('iframe'); ifr.src = g.payload.data; player.appendChild(ifr);
        } else if(g.payload.kind==='inline'){
          try{
            const data = g.payload.data;
            const arr = data.split(','); const mime = arr[0].match(/:(.*?);/)[1];
            const bstr = atob(arr[1]); let n = bstr.length; const u8 = new Uint8Array(n);
            while(n--) u8[n] = bstr.charCodeAt(n);
            const blob = new Blob([u8], {type:mime});
            const url = URL.createObjectURL(blob);
            const ifr = document.createElement('iframe'); ifr.src = url; player.appendChild(ifr);
          }catch(e){ player.innerHTML='<div class="muted">Unable to load HTML file.</div>' }
        }
      }

      if(g.type==='scratch'){
        const pid = g.payload.data;
        const ifr = document.createElement('iframe');
        // FIXED: Correct TurboWarp embed path
        ifr.src = 'https://turbowarp.org/'+encodeURIComponent(pid)+'/embed?autostart=true';
        player.appendChild(ifr);
      }

      if(g.type==='python'){
        const container = document.createElement('div'); container.style.display='flex'; container.style.flexDirection='column'; container.style.height='100%';
        const toolbar = document.createElement('div'); toolbar.style.display='flex'; toolbar.style.gap='8px'; toolbar.style.marginBottom='8px';
        const runBtn = document.createElement('button'); runBtn.textContent='Run'; runBtn.className='btn';
        const stopBtn = document.createElement('button'); stopBtn.textContent='Clear'; stopBtn.style.padding='8px';
        toolbar.appendChild(runBtn); toolbar.appendChild(stopBtn);
        const out = document.createElement('pre'); out.style.flex='1'; out.style.background='#02101a'; out.style.padding='8px'; out.style.borderRadius='8px'; out.style.overflow='auto'; out.style.color='#cbeef0'; out.textContent='Python output...';
        container.appendChild(toolbar); container.appendChild(out);
        player.appendChild(container);

        let pyodide = null;
        async function ensurePyodide(){ if(window.pyodide) return window.pyodide; const s = document.createElement('script'); s.src='https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js'; document.head.appendChild(s); await new Promise(r=>s.onload=r); window.pyodide = await loadPyodide(); return window.pyodide }

        runBtn.addEventListener('click', async ()=>{
          out.textContent='Loading Python runtime...'; try{
            pyodide = await ensurePyodide();
            let code=''; if(g.payload.kind==='inline'){
              const d = g.payload.data; const arr = d.split(','); const txt = decodeURIComponent(escape(atob(arr[1]))); code = txt;
            } else if(g.payload.kind==='code') code = g.payload.data;
            await pyodide.runPythonAsync(`import sys\nclass Capt:\n    def __init__(self): self.buf=[]\n    def write(self,s): self.buf.append(s)\n    def flush(self): pass\ncap=Capt()\nsys.stdout=cap\nsys.stderr=cap\n`);
            try{
              await pyodide.runPythonAsync(code);
              const res = pyodide.runPython('"".join(cap.buf)');
              out.textContent = res || '\n<no output>';
            } catch(pyErr){ out.textContent = 'Error:\n'+String(pyErr) }
          } catch(e){ out.textContent = 'Failed loading Pyodide: '+e }
        });
        stopBtn.addEventListener('click', ()=>{ out.textContent=''; });
      }
    }

    clearBtn.addEventListener('click', ()=>{ if(confirm('Clear local library?')){ localStorage.removeItem('gamehub_lib'); renderGallery(); } });
    refreshBtn.addEventListener('click', renderGallery);

    showSections(); renderGallery();
    document.body.addEventListener('dragover', e=> e.preventDefault());
    document.body.addEventListener('drop', async e=>{
      e.preventDefault(); const f = e.dataTransfer.files[0]; if(!f) return; if(f.type==='text/html'){ document.getElementById('htmlfile').files = e.dataTransfer.files; alert('HTML file attached to upload form — click Add to library.'); }
    });
  </script>
</body>
</html>
